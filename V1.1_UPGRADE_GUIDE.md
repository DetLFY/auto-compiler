# v1.1 升级指南

## 主要变化

### 1. README智能解析 (新功能)

系统现在会优先从README文件中学习如何构建项目。

**工作流程**：
```
1. 查找README文件 (README.md, README.txt等)
   ↓
2. 使用LLM提取构建指令
   ↓
3. 如果README中有明确指令，使用之
   ↓
4. 否则回退到自动检测构建系统
```

**示例**：
如果README中包含：
```markdown
## Building
mkdir build && cd build && cmake .. && make
```

系统会优先使用这个命令，而不是默认的CMake命令。

### 2. 无限循环修复

**问题（v1.0）**：
```
mkdir: cannot create directory 'build': File exists
→ LLM建议删除build目录
→ 执行删除和重建
→ 下次迭代仍然使用原始的 "mkdir build" 命令
→ 再次失败
→ 循环重复...
```

**解决方案（v1.1）**：
```python
# _attempt_build() 现在会更新 project_info
project_info['build_command'] = fixed_command

# ErrorHandler 可以返回新的构建命令
return {
    'success': True,
    'build_command': 'mkdir -p build && cd build && cmake .. && make'
}

# CompilerEngine 会应用新的构建命令
if fix_result.get('build_command'):
    project_info['build_command'] = fix_result['build_command']
```

### 3. 构建命令自动修正

**自动转换**：
- `mkdir build` → `mkdir -p build`
- `mkdir xxx` → `mkdir -p xxx`（在构建命令中）

**优点**：
- 避免"目录已存在"错误
- 使构建命令更健壮
- 减少LLM修复次数

## API变化

### ProjectAnalyzer

**新方法**：
```python
def _parse_readme(self, project_path: Path) -> Optional[Dict]:
    """
    解析README文件获取构建指令
    
    返回:
        Dict: {
            'build_command': str,
            'build_system': str,
            'dependencies': List[str],
            'languages': List[str],
            'project_type': str
        }
    """
```

**analyze_project() 更新**：
```python
# 新增字段
project_info = {
    # ... 原有字段 ...
    'readme_instructions': bool  # 是否从README获取指令
}
```

### ErrorHandler

**返回值变化**：
```python
# v1.0
def analyze_and_fix(...) -> bool:
    return success

# v1.1
def analyze_and_fix(...) -> Optional[Dict]:
    return {
        'success': True,
        'build_command': 'new_command'  # 可选
    }
```

**新的Tool参数**：
```json
{
  "name": "provide_fix_plan",
  "parameters": {
    "properties": {
      "new_build_command": {
        "type": "string",
        "description": "如果需要修改构建命令本身，在此提供新命令"
      }
    }
  }
}
```

### CompilerEngine

**_attempt_build() 更新**：
```python
# v1.0
def _attempt_build(project_info: Dict) -> Tuple[bool, str, str]:
    return (success, stdout, stderr)

# v1.1
def _attempt_build(project_info: Dict) -> Tuple[bool, str]:
    # 会就地修改 project_info['build_command']
    return (success, build_command)
```

## 使用示例

### 测试README解析

创建一个简单的项目：
```bash
mkdir test-project
cd test-project

# 创建README
cat > README.md << 'EOF'
# My Project

## Build Instructions
1. Install dependencies: apt-get install -y cmake gcc
2. Build:
   ```
   mkdir -p build
   cd build
   cmake ..
   make
   ```
EOF

# 创建简单的CMake项目
cat > CMakeLists.txt << 'EOF'
cmake_minimum_required(VERSION 3.10)
project(HelloWorld)
add_executable(hello main.c)
EOF

cat > main.c << 'EOF'
#include <stdio.h>
int main() {
    printf("Hello, World!\n");
    return 0;
}
EOF
```

运行编译器：
```bash
python main.py test-project
```

**预期行为**：
1. ✅ 找到README.md
2. ✅ 从README提取构建命令："mkdir -p build && cd build && cmake .. && make"
3. ✅ 从README提取依赖：["cmake", "gcc"]
4. ✅ 安装依赖
5. ✅ 使用README中的命令构建
6. ✅ 构建成功

## 向后兼容性

✅ **完全兼容v1.0配置文件**

✅ **如果项目没有README，行为与v1.0相同**

✅ **所有v1.0的命令行参数仍然有效**

## 升级建议

1. **更新代码**：直接替换新版本文件
2. **无需修改配置**：config.json保持不变
3. **建议添加README**：为你的测试项目添加README以充分利用新功能
4. **查看日志**：关注日志中的"从README文件中提取到构建指令"消息

## 故障排除

### README未被识别

**检查**：
- 文件名是否正确（README.md, README.txt等）
- 文件是否在项目根目录
- 文件编码是否为UTF-8

**日志**：
```
INFO - 找到README文件: README.md
INFO - 从README提取到构建信息: {...}
```

### 仍然出现无限循环

**可能原因**：
- LLM没有识别出需要修改构建命令
- 错误类型不是目录创建问题

**解决**：
- 检查日志中的"LLM建议更新构建命令为"消息
- 查看是否有 new_build_command 返回
- 考虑手动在README中提供正确的构建命令

### README解析失败

**可能原因**：
- README内容过于简单或不包含构建指令
- LLM无法理解README格式

**回退**：
系统会自动回退到v1.0的行为（自动检测构建系统）

## 性能影响

- **额外时间**：首次运行时增加 5-10秒（用于解析README）
- **Token消耗**：每个项目增加 ~1000 tokens（README解析）
- **成功率提升**：预计提升 20-30%（基于README指令的准确性）
